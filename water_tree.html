<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>浇树小应用</title>
  <style>
    :root{
      --bg:#0b0f19;
      --panel: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.12);
      --text:#e8eefc;
      --muted: rgba(232,238,252,.70);
      --shadow: 0 10px 26px rgba(0,0,0,.35);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(1000px 700px at 30% 10%, #14301f 0%, var(--bg) 55%, #070a12 100%);
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","PingFang SC","Hiragino Sans GB","Microsoft YaHei",sans-serif;
      padding: 12px;
    }
    .wrap{ max-width: 560px; margin: 0 auto; }
    .card{
      border-radius: 16px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    header{
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:baseline;
    }
    h1{ margin:0; font-size:14px; font-weight:900; }
    .sub{ font-size:12px; color:var(--muted); text-align:right; line-height:1.35; }

    .content{ padding: 12px 14px 14px; display:grid; gap:10px; }

    /* Scene (compact, no fixed huge min-height) */
    .scene{
      position:relative;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      padding: 10px;
      overflow:hidden;
    }
    .sceneInner{
      position:relative;
      height: 320px; /* compact height for Shortcuts sheet */
    }
    .ground{
      position:absolute;
      left:0; right:0;
      bottom:0;
      height: 46%;
      background:
        radial-gradient(800px 260px at 50% 0%, rgba(90,160,80,.18), rgba(0,0,0,0) 70%),
        linear-gradient(180deg, rgba(30,70,35,.0), rgba(20,60,28,.20) 35%, rgba(10,25,14,.55) 100%);
      border-top: 1px solid rgba(255,255,255,.06);
    }
    .soil{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      bottom:20px;
      width: min(460px, 92%);
      height: 110px;
      border-radius: 999px 999px 20px 20px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.06), rgba(255,255,255,.02) 40%, rgba(0,0,0,.35) 100%),
        linear-gradient(180deg, rgba(95,70,40,.30), rgba(45,30,18,.55));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 10px 40px rgba(0,0,0,.30);
    }

    .treeWrap{
      position:absolute;
      left:50%;
      transform: translateX(-50%);
      bottom: 35px;
      width: 320px;
      height: 260px;
      display:grid;
      place-items:end center;
      user-select:none;
      touch-action: manipulation;
    }
    .trunk{
      position:relative;
      width: 26px;
      height: 150px;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(170,120,70,.95), rgba(120,75,38,.92));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.20), 0 10px 18px rgba(0,0,0,.22);
      transform-origin: 50% 100%;
      transition: height 360ms ease, width 360ms ease, transform 360ms ease;
    }
    .canopy{
      position:absolute;
      left:50%;
      bottom: 140px;
      transform: translateX(-50%);
      width: 170px;
      height: 145px;
      border-radius: 50%;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.16), rgba(255,255,255,0) 42%),
        radial-gradient(circle at 50% 50%, rgba(90,210,120,.52), rgba(40,140,70,.55));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.20), 0 12px 24px rgba(0,0,0,.26);
      transition: width 360ms ease, height 360ms ease, bottom 360ms ease, filter 360ms ease;
      filter: saturate(1.10);
      overflow:hidden;
    }
    .leaf{
      position:absolute;
      width: 14px;
      height: 9px;
      border-radius: 999px 999px 999px 4px;
      background: linear-gradient(180deg, rgba(140,255,170,.85), rgba(60,180,100,.75));
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 6px 10px rgba(0,0,0,.16);
      opacity: 0;
      transform: scale(.6) rotate(0deg);
      transition: opacity 240ms ease, transform 320ms ease;
    }
    .drop{
      position:absolute;
      width: 10px;
      height: 14px;
      border-radius: 999px;
      background:
        radial-gradient(circle at 30% 25%, rgba(255,255,255,.75), rgba(255,255,255,0) 40%),
        linear-gradient(180deg, rgba(120,190,255,.95), rgba(50,130,230,.85));
      border: 1px solid rgba(255,255,255,.14);
      filter: drop-shadow(0 8px 12px rgba(0,0,0,.22));
      pointer-events:none;
      opacity:0;
    }

    /* stages */
    .treeWrap[data-stage="0"] .trunk { height: 120px; width: 24px; transform: rotate(-.6deg); }
    .treeWrap[data-stage="0"] .canopy { width: 140px; height: 120px; bottom: 115px; }
    .treeWrap[data-stage="1"] .trunk { height: 145px; width: 26px; transform: rotate(0deg); }
    .treeWrap[data-stage="1"] .canopy { width: 170px; height: 145px; bottom: 140px; }
    .treeWrap[data-stage="2"] .trunk { height: 170px; width: 28px; transform: rotate(.3deg); }
    .treeWrap[data-stage="2"] .canopy { width: 200px; height: 170px; bottom: 160px; }
    .treeWrap[data-stage="3"] .trunk { height: 195px; width: 30px; transform: rotate(0deg); }
    .treeWrap[data-stage="3"] .canopy { width: 225px; height: 192px; bottom: 178px; filter:saturate(1.15); }
    .treeWrap[data-stage="4"] .trunk { height: 210px; width: 32px; transform: rotate(-.2deg); }
    .treeWrap[data-stage="4"] .canopy { width: 245px; height: 210px; bottom: 188px; filter:saturate(1.20); }

    /* controls */
    .controls{
      display:grid;
      gap:10px;
    }
    .btnRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    button{
      padding: 12px 12px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(18,26,43,.55);
      color: var(--text);
      font-weight: 900;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    button.primary{
      border-color: rgba(110,168,255,.42);
      background: linear-gradient(180deg, rgba(110,168,255,.32), rgba(110,168,255,.12));
    }
    button:active{ transform: translateY(1px); }

    .meterRow{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      color: var(--muted);
      margin-top: 2px;
      margin-bottom: 6px;
    }
    .bar{
      height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      overflow:hidden;
    }
    .fill{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(120,190,255,.75), rgba(120,190,255,.15));
      transition: width 260ms ease;
    }
    .hint{
      font-size:12px;
      color: var(--muted);
      line-height:1.45;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="application" aria-label="浇树小应用">
      <header>
        <h1>浇树小应用</h1>
        <div class="sub">适配 Shortcuts 小窗口<br>点击“浇水”长大</div>
      </header>

      <div class="content">
        <div class="scene" aria-label="场景">
          <div class="sceneInner" id="sceneInner">
            <div class="treeWrap" id="tree" data-stage="0" aria-label="树">
              <div class="canopy" id="canopy" aria-hidden="true"></div>
              <div class="trunk" aria-hidden="true"></div>
            </div>
            <div class="soil" aria-hidden="true"></div>
            <div class="ground" aria-hidden="true"></div>
          </div>
        </div>

        <div class="controls">
          <div class="btnRow">
            <button class="primary" id="waterBtn" type="button">浇水</button>
            <button id="resetBtn" type="button">重置</button>
          </div>

          <div>
            <div class="meterRow"><span>水量</span><span id="waterText">0 / 100</span></div>
            <div class="bar" aria-hidden="true"><div class="fill" id="waterFill"></div></div>
          </div>

          <div>
            <div class="meterRow"><span>阶段</span><span id="stageText">0 / 4</span></div>
            <div class="bar" aria-hidden="true"><div class="fill" id="stageFill"></div></div>
          </div>

          <div class="hint">每次浇水 +8；水会缓慢蒸发；阶段越高树越大、叶子越多。</div>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const tree = document.getElementById('tree');
  const canopy = document.getElementById('canopy');
  const waterBtn = document.getElementById('waterBtn');
  const resetBtn = document.getElementById('resetBtn');
  const waterFill = document.getElementById('waterFill');
  const stageFill = document.getElementById('stageFill');
  const waterText = document.getElementById('waterText');
  const stageText = document.getElementById('stageText');

  let water = 0;
  let stage = 0;
  const maxStage = 4;
  const thresholds = [0, 18, 38, 62, 88];

  const leaves = [];
  const maxLeaves = 32;

  function clamp(n,a,b){ return Math.max(a, Math.min(b,n)); }
  function rand(min,max){ return Math.random()*(max-min)+min; }

  function createLeaf(){
    const leaf = document.createElement('div');
    leaf.className = 'leaf';
    canopy.appendChild(leaf);
    leaves.push({ el: leaf, r: 0, s: 1, visible: false });
    return leaves[leaves.length-1];
  }
  function ensureLeaves(n){
    while (leaves.length < n && leaves.length < maxLeaves) createLeaf();
  }
  function placeLeaf(item){
    const w = canopy.clientWidth;
    const h = canopy.clientHeight;

    const angle = rand(0, Math.PI*2);
    const radius = Math.pow(Math.random(), 0.7) * 0.46;
    const cx = 0.5 + Math.cos(angle) * radius;
    const cy = 0.52 + Math.sin(angle) * radius * 0.85;

    const x = cx * w;
    const y = cy * h;

    item.r = rand(-35, 35);
    item.s = rand(0.85, 1.2);

    item.el.style.left = `${x}px`;
    item.el.style.top = `${y}px`;
    item.el.style.transform = `translate(-50%, -50%) scale(${item.s}) rotate(${item.r}deg)`;
  }

  function renderLeaves(){
    const target = Math.round(5 + stage*6 + (water/100)*10);
    ensureLeaves(target);

    for (let i=0;i<leaves.length;i++){
      const item = leaves[i];
      const shouldShow = i < target;
      if (shouldShow && !item.visible){
        placeLeaf(item);
        item.visible = true;
        requestAnimationFrame(() => {
          item.el.style.opacity = '0.92';
          item.el.style.transform = `translate(-50%, -50%) scale(${item.s}) rotate(${item.r}deg)`;
        });
      } else if (!shouldShow && item.visible){
        item.visible = false;
        item.el.style.opacity = '0';
        item.el.style.transform = `translate(-50%, -50%) scale(.6) rotate(${item.r}deg)`;
      }
    }
  }

  function spawnDrops(){
    const scene = document.getElementById('sceneInner');
    const rectTree = tree.getBoundingClientRect();
    const rectScene = scene.getBoundingClientRect();

    const startX = rectScene.width - 40;
    const startY = 10;

    const endX = (rectTree.left + rectTree.width/2) - rectScene.left + rand(-25, 25);
    const endY = (rectTree.top + rectTree.height*0.18) - rectScene.top + rand(-10, 20);

    for (let i=0;i<8;i++){
      const d = document.createElement('div');
      d.className = 'drop';
      scene.appendChild(d);

      const x0 = startX + rand(-10, 10);
      const y0 = startY + rand(-6, 8);
      const x1 = endX + rand(-22, 22);
      const y1 = endY + rand(-8, 16);
      const delay = rand(0, 110);

      d.style.left = `${x0}px`;
      d.style.top = `${y0}px`;
      d.style.opacity = '0';

      setTimeout(() => {
        d.style.opacity = '0.95';
        d.animate([
          { transform: 'translate(0,0) scale(1)', opacity: 0.95 },
          { transform: `translate(${(x1-x0).toFixed(1)}px, ${(y1-y0).toFixed(1)}px) scale(0.9)`, opacity: 0.95 },
          { transform: `translate(${(x1-x0).toFixed(1)}px, ${(y1-y0+30).toFixed(1)}px) scale(0.7)`, opacity: 0 }
        ], { duration: 620 + rand(0, 180), easing: 'cubic-bezier(.2,.8,.2,1)', fill: 'forwards' });

        setTimeout(() => d.remove(), 1000);
      }, delay);
    }
  }

  function updateUI(){
    water = clamp(water, 0, 100);

    let newStage = 0;
    for (let i=0;i<=maxStage;i++){
      if (water >= thresholds[i]) newStage = i;
    }
    if (newStage !== stage){
      stage = newStage;
      tree.dataset.stage = String(stage);
      // gentle pop
      tree.animate([{transform:'translateX(-50%) scale(1)'},{transform:'translateX(-50%) scale(1.03)'},{transform:'translateX(-50%) scale(1)'}],
                   {duration: 360, easing:'ease-out'});
    }

    waterFill.style.width = `${water}%`;
    stageFill.style.width = `${(stage/maxStage)*100}%`;
    waterText.textContent = `${Math.round(water)} / 100`;
    stageText.textContent = `${stage} / ${maxStage}`;
    renderLeaves();
  }

  function waterOnce(){
    water += 8;
    spawnDrops();
    updateUI();
  }

  function resetAll(){
    water = 0;
    stage = 0;
    tree.dataset.stage = '0';
    leaves.forEach(it => { it.visible = false; it.el.style.opacity = '0'; });
    updateUI();
  }

  // evaporation
  setInterval(() => {
    const prev = water;
    water = Math.max(0, water - 1.1);
    if (Math.round(prev) !== Math.round(water)) updateUI();
  }, 1300);

  waterBtn.addEventListener('click', waterOnce);
  resetBtn.addEventListener('click', resetAll);

  // init
  ensureLeaves(14);
  updateUI();
})();
</script>
</body>
</html>
